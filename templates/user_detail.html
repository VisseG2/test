{% extends 'base.html' %}
{% block title %}–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ user.name|e }}{% endblock %}
{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-user-circle"></i> {{ user.name|e }}</h1>
        <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-id-badge"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>PIN (ID):</strong> <span class="badge bg-primary fs-6">{{ user.pin|e }}</span></p>
                            <p><strong>–ò–º—è:</strong> {{ user.name|e }}</p>
                            <p><strong>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</strong> 
                                {% if user.card_no %}
                                    <span class="badge bg-info">{{ user.card_no|e }}</span>
                                {% else %}
                                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:</strong>
                                {% if user.privilege == 14 %}
                                    <span class="badge bg-danger">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                {% elif user.privilege == 1 %}
                                    <span class="badge bg-warning">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞</span>
                                {% else %}
                                    <span class="badge bg-success">–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                {% endif %}
                            </p>
                            {% if user.message_to_display %}
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-envelope"></i> <strong>–û–∂–∏–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                                {{ user.message_to_display|e }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0"><i class="fas fa-chart-pie"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>–û—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–∞–ª—å—Ü–µ–≤:</span>
                        <span class="badge bg-success">{{ biometrics|selectattr('bio_type', 'equalto', 0)|list|length }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>–®–∞–±–ª–æ–Ω—ã –ª–∏—Ü–∞:</span>
                        <span class="badge bg-info">{{ biometrics|selectattr('bio_type', 'equalto', 9)|list|length }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0"><i class="fas fa-fingerprint"></i> –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h5>
            <div class="btn-group" role="group">
                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#enrollFingerprintModal">
                    <i class="fas fa-fingerprint"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø–µ—á–∞—Ç–æ–∫
                </button>
                <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#uploadFaceModal">
                    <i class="fas fa-camera"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if biometrics %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for bio in biometrics %}
                        <tr>
                            <td>
                                {% if bio.bio_type == 9 %}
                                    <span class="badge bg-info"><i class="fas fa-user"></i> –õ–∏—Ü–æ</span>
                                {% elif bio.bio_type == 0 %}
                                    <span class="badge bg-success"><i class="fas fa-fingerprint"></i> –û—Ç–ø–µ—á–∞—Ç–æ–∫</span>
                                {% else %}
                                    <span class="badge bg-secondary">–¢–∏–ø {{ bio.bio_type }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if bio.bio_type == 9 %}
                                    –®–∞–±–ª–æ–Ω –ª–∏—Ü–∞
                                {% elif bio.bio_type == 0 %}
                                    {% set finger_names = {
                                        0: '–ë–æ–ª—å—à–æ–π (–ø—Ä–∞–≤–∞—è)',
                                        1: '–£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π (–ø—Ä–∞–≤–∞—è)',
                                        2: '–°—Ä–µ–¥–Ω–∏–π (–ø—Ä–∞–≤–∞—è)',
                                        3: '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π (–ø—Ä–∞–≤–∞—è)',
                                        4: '–ú–∏–∑–∏–Ω–µ—Ü (–ø—Ä–∞–≤–∞—è)',
                                        5: '–ë–æ–ª—å—à–æ–π (–ª–µ–≤–∞—è)',
                                        6: '–£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π (–ª–µ–≤–∞—è)',
                                        7: '–°—Ä–µ–¥–Ω–∏–π (–ª–µ–≤–∞—è)',
                                        8: '–ë–µ–∑—ã–º—è–Ω–Ω—ã–π (–ª–µ–≤–∞—è)',
                                        9: '–ú–∏–∑–∏–Ω–µ—Ü (–ª–µ–≤–∞—è)'
                                    } %}
                                    {{ finger_names.get(bio.finger_id, '–ü–∞–ª–µ—Ü ' + bio.finger_id|string) }}
                                {% else %}
                                    –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ bio.template_data|length }} —Å–∏–º–≤–æ–ª–æ–≤</span>
                            </td>
                            <td>
                                <a href="{{ url_for('delete_biometric', pin=user.pin, bio_type=bio.bio_type, finger_id=bio.finger_id) }}" 
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4">
                <i class="fas fa-fingerprint fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h6>
                <p class="text-muted">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤ –ø–∞–ª—å—Ü–µ–≤ –∏–ª–∏ —Ñ–æ—Ç–æ –ª–∏—Ü–∞.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0"><i class="fas fa-envelope"></i> –°–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —É—Å–ø–µ—à–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –≤ —Ä–µ–∂–∏–º–µ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.</p>
            <form method="post">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" name="message" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ -->
    <div class="modal fade" id="enrollFingerprintModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–£–¥–∞–ª–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ø–µ—á–∞—Ç–∫–∞ –ø–∞–ª—å—Ü–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –ø–∞–ª–µ—Ü –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–ø–µ—á–∞—Ç–∫–∞:</p>
                    
                    {% for device in devices %}
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: <span class="badge bg-dark">{{ device.sn }}</span></h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header py-2 text-center bg-primary text-white">
                                        <i class="fas fa-hand-paper"></i> –ü—Ä–∞–≤–∞—è —Ä—É–∫–∞
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="d-grid gap-2">
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=0) }}" class="btn btn-outline-primary btn-sm">ü§è –ë–æ–ª—å—à–æ–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=1) }}" class="btn btn-outline-primary btn-sm">üëÜ –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=2) }}" class="btn btn-outline-primary btn-sm">üñï –°—Ä–µ–¥–Ω–∏–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=3) }}" class="btn btn-outline-primary btn-sm">üíç –ë–µ–∑—ã–º—è–Ω–Ω—ã–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=4) }}" class="btn btn-outline-primary btn-sm">ü§ô –ú–∏–∑–∏–Ω–µ—Ü</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header py-2 text-center bg-secondary text-white">
                                        <i class="fas fa-hand-paper fa-flip-horizontal"></i> –õ–µ–≤–∞—è —Ä—É–∫–∞
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="d-grid gap-2">
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=5) }}" class="btn btn-outline-secondary btn-sm">ü§è –ë–æ–ª—å—à–æ–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=6) }}" class="btn btn-outline-secondary btn-sm">üëÜ –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=7) }}" class="btn btn-outline-secondary btn-sm">üñï –°—Ä–µ–¥–Ω–∏–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=8) }}" class="btn btn-outline-secondary btn-sm">üíç –ë–µ–∑—ã–º—è–Ω–Ω—ã–π</a>
                                            <a href="{{ url_for('enroll_fingerprint', device_sn=device.sn, pin=user.pin, finger_id=9) }}" class="btn btn-outline-secondary btn-sm">ü§ô –ú–∏–∑–∏–Ω–µ—Ü</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
    <div class="modal fade" id="uploadFaceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –ª–∏—Ü–∞</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –ª–∏—Ü–∞ (JPG, PNG)</label>
                            <input type="file" name="face_photo" class="form-control" accept="image/*" required>
                            <div class="form-text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –∞–Ω—Ñ–∞—Å, —Ä–∞–∑–º–µ—Ä–æ–º –Ω–µ –±–æ–ª–µ–µ 5–ú–ë.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</label>
                            <select name="device_sn" class="form-select" required>
                                {% for device in devices %}
                                <option value="{{ device.sn }}">{{ device.sn }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-info">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
